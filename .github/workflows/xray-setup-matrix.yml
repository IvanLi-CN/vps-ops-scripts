name: Test Xray Setup Script

on:
  workflow_dispatch:
  push:
    paths:
      - "xray/**"
      - ".github/workflows/xray-setup-matrix.yml"
  pull_request:
    paths:
      - "xray/**"
      - ".github/workflows/xray-setup-matrix.yml"

jobs:
  xray-setup:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: archlinux
            image: archlinux:latest
            asset_pattern: Xray-linux-64.zip
          - name: alpine
            image: alpine:3.19
            asset_pattern: Xray-linux-musl-64.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run setup-xray-vless-ss.sh in ${{ matrix.image }}
        run: |
          cat > /tmp/xray-ci.sh <<'EOSH'
          set -e

          if command -v apk >/dev/null 2>&1; then
            apk update >/dev/null
            apk add --no-cache curl unzip tzdata ca-certificates openssl jq gcompat perl python3 >/dev/null
          else
            pacman -Sy --noconfirm curl unzip ca-certificates tzdata openssl jq perl python >/dev/null
          fi

          mkdir -p /tmp/xray && cd /tmp/xray

          release_json=$(curl -fsSL https://api.github.com/repos/XTLS/Xray-core/releases/latest)
          XRAY_ZIP=$(printf "%s" "$release_json" | jq -r '.assets[] | select(.name=="${{ matrix.asset_pattern }}") | .browser_download_url' | head -n1)
          if [ -z "$XRAY_ZIP" ]; then
            XRAY_ZIP=$(printf "%s" "$release_json" | jq -r '.assets[] | select(.name | contains("Xray-linux-64.zip")) | .browser_download_url' | head -n1)
          fi
          if [ -z "$XRAY_ZIP" ]; then
            echo "Cannot locate Xray binary download URL"; exit 1
          fi

          echo "Downloading Xray from $XRAY_ZIP"
          curl -fsSL "$XRAY_ZIP" -o xray.zip
          unzip -q xray.zip
          install -m 0755 xray /usr/local/bin/xray
          # ensure geo assets exist so `xray run -test` won't error
          install -d /usr/local/share/xray
          install -m 0644 geoip.dat geosite.dat /usr/local/share/xray/
          export XRAY_LOCATION_ASSET=/usr/local/share/xray

          cd /workspace

          # Feed answers to the interactive prompts:
          # 1) service name (empty to accept default)
          # 2) REALITY domain (required)
          # 3) VLESS port (default 443)
          # 4) SS2022 port (default 8443)
          set -x
          printf "\nexample.com\n443\n8443\n" | /bin/sh ./xray/setup-xray-vless-ss.sh

          CONFIG=/usr/local/etc/xray/vless-ss-reality.yaml
          test -f "$CONFIG"
          echo "------ rendered config (head) ------"
          sed -n '1,80p' "$CONFIG"
          echo "------ rendered config (tail) ------"
          tail -n 40 "$CONFIG"
          # ensure no unreplaced placeholders remain
          if grep -Eq '\$PORT_VLESS\$|\$PORT_SS\$|\$DOMAIN\$|\$ID\$|\$PRIVATE_KEY\$|\$PASSWORD\$' "$CONFIG"; then
            echo "Placeholder substitution failed"; exit 1; fi
          xray run -test -c "$CONFIG" -format yaml
          EOSH

          docker run --rm -i \
            -v "$PWD":/workspace \
            -v /tmp/xray-ci.sh:/tmp/xray-ci.sh:ro \
            --workdir /workspace \
            --name xray-ci-${{ matrix.name }} \
            ${{ matrix.image }} \
            /bin/sh /tmp/xray-ci.sh

  xray-setup-systemd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y curl unzip jq ca-certificates >/dev/null

      - name: Install Xray (binary + geo assets)
        run: |
          set -e
          mkdir -p /tmp/xray && cd /tmp/xray

          release_json=$(curl -fsSL https://api.github.com/repos/XTLS/Xray-core/releases/latest)
          XRAY_ZIP=$(printf "%s" "$release_json" | jq -r '.assets[] | select(.name=="Xray-linux-64.zip") | .browser_download_url' | head -n1)
          if [ -z "$XRAY_ZIP" ]; then
            echo "Cannot locate Xray binary download URL"; exit 1
          fi

          echo "Downloading Xray from $XRAY_ZIP"
          curl -fsSL "$XRAY_ZIP" -o xray.zip
          unzip -q xray.zip

          sudo install -m 0755 xray /usr/local/bin/xray
          sudo install -d /usr/local/share/xray
          sudo install -m 0644 geoip.dat geosite.dat /usr/local/share/xray/

      - name: Run setup script (systemd path)
        run: |
          set -e
          sudo env XRAY_LOCATION_ASSET=/usr/local/share/xray sh -c 'printf "xray-ci\nexample.com\n14443\n18443\n" | /bin/sh ./xray/setup-xray-vless-ss.sh'

          sudo systemctl is-enabled xray-ci.service
          sudo systemctl is-active xray-ci.service

      - name: Cleanup
        if: always()
        run: |
          sudo systemctl disable --now xray-ci.service >/dev/null 2>&1 || true
          sudo rm -f /etc/systemd/system/xray-ci.service || true
          sudo systemctl daemon-reload >/dev/null 2>&1 || true
          sudo rm -rf /usr/local/etc/xray /var/log/xray || true
