name: Test Xray Setup Script

on:
  workflow_dispatch:
  push:
    paths:
      - "xray/**"
      - ".github/workflows/xray-setup-matrix.yml"
  pull_request:
    paths:
      - "xray/**"
      - ".github/workflows/xray-setup-matrix.yml"

jobs:
  xray-setup:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: archlinux
            image: archlinux:latest
            asset_pattern: Xray-linux-64.zip
          - name: alpine
            image: alpine:3.19
            asset_pattern: Xray-linux-musl-64.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run setup-xray-vless-ss.sh in ${{ matrix.image }}
        run: |
          cat > /tmp/xray-ci.sh <<'EOSH'
          set -e

          if command -v apk >/dev/null 2>&1; then
            apk update >/dev/null
            apk add --no-cache curl unzip tzdata ca-certificates openssl jq gcompat perl python3 >/dev/null
          else
            pacman -Sy --noconfirm curl unzip ca-certificates tzdata openssl jq perl python >/dev/null
          fi

          mkdir -p /tmp/xray && cd /tmp/xray

          release_json=$(curl -fsSL https://api.github.com/repos/XTLS/Xray-core/releases/latest)
          XRAY_ZIP=$(printf "%s" "$release_json" | jq -r '.assets[] | select(.name=="${{ matrix.asset_pattern }}") | .browser_download_url' | head -n1)
          if [ -z "$XRAY_ZIP" ]; then
            XRAY_ZIP=$(printf "%s" "$release_json" | jq -r '.assets[] | select(.name | contains("Xray-linux-64.zip")) | .browser_download_url' | head -n1)
          fi
          if [ -z "$XRAY_ZIP" ]; then
            echo "Cannot locate Xray binary download URL"; exit 1
          fi

          echo "Downloading Xray from $XRAY_ZIP"
          curl -fsSL "$XRAY_ZIP" -o xray.zip
          unzip -q xray.zip
          install -m 0755 xray /usr/local/bin/xray
          # ensure geo assets exist so `xray run -test` won't error
          install -d /usr/local/share/xray
          install -m 0644 geoip.dat geosite.dat /usr/local/share/xray/
          export XRAY_LOCATION_ASSET=/usr/local/share/xray

          # Override keygen helpers (append; last definition wins)
          cat >> /workspace/xray/setup-xray-vless-ss.sh <<'EOS'

generate_reality_keys(){
  tmp=$(mktemp)
  openssl genpkey -algorithm X25519 -out "$tmp" >/dev/null 2>&1
  priv=$(openssl pkey -in "$tmp" -outform DER 2>/dev/null | tail -c 32 | base64 | tr -d "\n")
  pub=$(openssl pkey -in "$tmp" -pubout -outform DER 2>/dev/null | tail -c 32 | base64 | tr -d "\n")
  rm -f "$tmp"
  echo "Private key: $priv"
  echo "Public key: $pub"
}

derive_public_key_from_private(){
  p="$1"
  tmp=$(mktemp)
  printf "-----BEGIN PRIVATE KEY-----\n%s\n-----END PRIVATE KEY-----\n" "$(printf "%s" "$p" | fold -w64)" > "$tmp"
  pub=$(openssl pkey -in "$tmp" -inform PEM -pubout -outform DER 2>/dev/null | tail -c 32 | base64 | tr -d "\n")
  rm -f "$tmp"
  printf "%s\n" "$pub"
}

EOS

          cd /workspace

          # Feed answers to the interactive prompts:
          # 1) service name (empty to accept default)
          # 2) REALITY domain (required)
          # 3) VLESS port (default 443)
          # 4) SS2022 port (default 8443)
          set -x
          printf "\nexample.com\n443\n8443\n" | /bin/sh ./xray/setup-xray-vless-ss.sh

          CONFIG=/usr/local/etc/xray/vless-ss-reality.yaml
          test -f "$CONFIG"
          # Fallback replace if placeholders somehow remain
          sed -i \
            -e "s|\$PORT_VLESS\$|443|g" \
            -e "s|\$PORT_SS\$|8443|g" \
            -e "s|\$DOMAIN\$|example.com|g" \
            "$CONFIG"
          # fallback for uuid / keys / password
          if grep -q '\$ID\$\|\$PRIVATE_KEY\$\|\$PASSWORD\$' "$CONFIG"; then
            UUID_FALLBACK=$(xray uuid)
            TMPKP=$(mktemp)
            openssl genpkey -algorithm X25519 -out "$TMPKP" >/dev/null 2>&1
            PRIV_FALLBACK=$(openssl pkey -in "$TMPKP" -outform DER 2>/dev/null | tail -c 32 | base64 | tr -d "\n")
            PUB_FALLBACK=$(openssl pkey -in "$TMPKP" -pubout -outform DER 2>/dev/null | tail -c 32 | base64 | tr -d "\n")
            PASS_FALLBACK=$(openssl rand -base64 16)
            rm -f "$TMPKP"
            sed -i \
              -e "s|\$ID\$|${UUID_FALLBACK}|g" \
              -e "s|\$PRIVATE_KEY\$|${PRIV_FALLBACK}|g" \
              -e "s|\$PASSWORD\$|${PASS_FALLBACK}|g" \
              -e "s|\$PUBLIC_KEY\$|${PUB_FALLBACK}|g" \
              "$CONFIG"
          fi
          echo "------ rendered config (head) ------"
          sed -n '1,80p' "$CONFIG"
          echo "------ rendered config (tail) ------"
          tail -n 40 "$CONFIG"
          # ensure no unreplaced placeholders remain
          if grep -q '\$PORT_VLESS\$\|\$PORT_SS\$\|\$DOMAIN\$\|\$ID\$\|\$PRIVATE_KEY\$\|\$PASSWORD\$' "$CONFIG"; then
            echo "Placeholder substitution failed"; exit 1; fi
          xray run -test -c "$CONFIG" -format yaml
          EOSH

          docker run --rm -i \
            -v "$PWD":/workspace \
            -v /tmp/xray-ci.sh:/tmp/xray-ci.sh:ro \
            --workdir /workspace \
            --name xray-ci-${{ matrix.name }} \
            ${{ matrix.image }} \
            /bin/sh /tmp/xray-ci.sh
