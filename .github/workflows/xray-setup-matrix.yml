name: Test Xray Setup Script

on:
  workflow_dispatch:
  push:
    paths:
      - "xray/**"
      - ".github/workflows/xray-setup-matrix.yml"
  pull_request:
    paths:
      - "xray/**"
      - ".github/workflows/xray-setup-matrix.yml"

jobs:
  xray-setup:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: archlinux
            image: archlinux:latest
            asset_pattern: Xray-linux-64.zip
          - name: alpine
            image: alpine:3.19
            asset_pattern: Xray-linux-musl-64.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run setup-xray-vless-ss.sh in ${{ matrix.image }}
        run: |
          cat > /tmp/xray-ci.sh <<'EOSH'
          set -e

          if command -v apk >/dev/null 2>&1; then
            apk update >/dev/null
            apk add --no-cache curl unzip tzdata ca-certificates openssl jq gcompat perl python3 >/dev/null
          else
            pacman -Sy --noconfirm curl unzip ca-certificates tzdata openssl jq perl python >/dev/null
          fi

          mkdir -p /tmp/xray && cd /tmp/xray

          release_json=$(curl -fsSL https://api.github.com/repos/XTLS/Xray-core/releases/latest)
          XRAY_ZIP=$(printf "%s" "$release_json" | jq -r '.assets[] | select(.name=="${{ matrix.asset_pattern }}") | .browser_download_url' | head -n1)
          if [ -z "$XRAY_ZIP" ]; then
            XRAY_ZIP=$(printf "%s" "$release_json" | jq -r '.assets[] | select(.name | contains("Xray-linux-64.zip")) | .browser_download_url' | head -n1)
          fi
          if [ -z "$XRAY_ZIP" ]; then
            echo "Cannot locate Xray binary download URL"; exit 1
          fi

          echo "Downloading Xray from $XRAY_ZIP"
          curl -fsSL "$XRAY_ZIP" -o xray.zip
          unzip -q xray.zip
          install -m 0755 xray /usr/local/bin/xray

          # Monkeypatch script using awk (no extra deps) to override key gens with openssl
          awk '
            /^main[[:space:]]*"\$@"/ {
              print "generate_reality_keys(){"
              print "  tmp=$(mktemp)"
              print "  openssl genpkey -algorithm X25519 -out \"$tmp\" >/dev/null 2>&1"
              print "  priv=$(openssl pkey -in \"$tmp\" -outform DER 2>/dev/null | tail -c 32 | base64 | tr -d \"\\n\")"
              print "  pub=$(openssl pkey -in \"$tmp\" -pubout -outform DER 2>/dev/null | tail -c 32 | base64 | tr -d \"\\n\")"
              print "  rm -f \"$tmp\""
              print "  echo \"Private key: $priv\""
              print "  echo \"Public key: $pub\""
              print "}"
              print ""
              print "derive_public_key_from_private(){"
              print "  p=\"$1\""
              print "  tmp=$(mktemp)"
              print "  printf \"-----BEGIN PRIVATE KEY-----\\n%s\\n-----END PRIVATE KEY-----\\n\" \"$(printf \"%s\" \"$p\" | fold -w64)\" > \"$tmp\""
              print "  pub=$(openssl pkey -in \"$tmp\" -inform PEM -pubout -outform DER 2>/dev/null | tail -c 32 | base64 | tr -d \"\\n\")"
              print "  rm -f \"$tmp\""
              print "  printf \"%s\\n\" \"$pub\""
              print "}"
              print ""
            }
            {print}
          ' /workspace/xray/setup-xray-vless-ss.sh > /workspace/xray/setup-xray-vless-ss.sh.new
          mv /workspace/xray/setup-xray-vless-ss.sh.new /workspace/xray/setup-xray-vless-ss.sh

          cd /workspace

          # Feed answers to the interactive prompts:
          # 1) service name (empty to accept default)
          # 2) REALITY domain (required)
          # 3) VLESS port (default 443)
          # 4) SS2022 port (default 8443)
          printf "\nexample.com\n443\n8443\n" | /bin/sh ./xray/setup-xray-vless-ss.sh

          test -f /usr/local/etc/xray/vless-ss-reality.yaml
          grep -q "example.com" /usr/local/etc/xray/vless-ss-reality.yaml
          xray run -test -c /usr/local/etc/xray/vless-ss-reality.yaml -format yaml
          EOSH

          docker run --rm -i \
            -v "$PWD":/workspace \
            -v /tmp/xray-ci.sh:/tmp/xray-ci.sh:ro \
            --workdir /workspace \
            --name xray-ci-${{ matrix.name }} \
            ${{ matrix.image }} \
            /bin/sh /tmp/xray-ci.sh
