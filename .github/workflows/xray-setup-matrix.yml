name: Test Xray Setup Script

on:
  workflow_dispatch:
  push:
    paths:
      - "xray/**"
      - ".github/workflows/xray-setup-matrix.yml"
  pull_request:
    paths:
      - "xray/**"
      - ".github/workflows/xray-setup-matrix.yml"

jobs:
  xray-setup:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: archlinux
            image: archlinux:latest
            asset_pattern: Xray-linux-64.zip
          - name: alpine
            image: alpine:3.20
            asset_pattern: Xray-linux-musl-64.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run setup-xray-vless-ss.sh in ${{ matrix.image }}
        run: |
          cat > /tmp/xray-ci.sh <<'EOSH'
          set -e

          if command -v apk >/dev/null 2>&1; then
            apk update >/dev/null
            apk add --no-cache curl unzip tzdata ca-certificates openssl jq gcompat perl python3 >/dev/null
          else
            pacman -Sy --noconfirm curl unzip ca-certificates tzdata openssl jq perl python >/dev/null
          fi

          mkdir -p /tmp/xray && cd /tmp/xray

          release_json=$(curl -fsSL https://api.github.com/repos/XTLS/Xray-core/releases/latest)
          XRAY_ZIP=$(printf "%s" "$release_json" | jq -r '.assets[] | select(.name=="${{ matrix.asset_pattern }}") | .browser_download_url' | head -n1)
          if [ -z "$XRAY_ZIP" ]; then
            XRAY_ZIP=$(printf "%s" "$release_json" | jq -r '.assets[] | select(.name | contains("Xray-linux-64.zip")) | .browser_download_url' | head -n1)
          fi
          if [ -z "$XRAY_ZIP" ]; then
            echo "Cannot locate Xray binary download URL"; exit 1
          fi

          echo "Downloading Xray from $XRAY_ZIP"
          curl -fsSL "$XRAY_ZIP" -o xray.zip
          unzip -q xray.zip
          install -m 0755 xray /usr/local/bin/xray
          # ensure geo assets exist so `xray run -test` won't error
          install -d /usr/local/share/xray
          install -m 0644 geoip.dat geosite.dat /usr/local/share/xray/
          export XRAY_LOCATION_ASSET=/usr/local/share/xray

          cd /workspace

          # Feed answers to the interactive prompts:
          # 1) service name (empty to accept default)
          # 2) REALITY domain (required)
          # 3) VLESS port (default 443)
          # 4) SS2022 port (default 8443)
          set -x
          printf "\nexample.com\n443\n8443\n" | /bin/sh ./xray/setup-xray-vless-ss.sh

          CONFIG=/usr/local/etc/xray/vless-ss-reality.yaml
          test -f "$CONFIG"
          echo "------ rendered config (head) ------"
          sed -n '1,80p' "$CONFIG"
          echo "------ rendered config (tail) ------"
          tail -n 40 "$CONFIG"
          # ensure no unreplaced placeholders remain
          if grep -Eq '\$PORT_VLESS\$|\$PORT_SS\$|\$DOMAIN\$|\$ID\$|\$PRIVATE_KEY\$|\$PASSWORD\$' "$CONFIG"; then
            echo "Placeholder substitution failed"; exit 1; fi
          xray run -test -c "$CONFIG" -format yaml
          EOSH

          docker run --rm -i \
            -v "$PWD":/workspace \
            -v /tmp/xray-ci.sh:/tmp/xray-ci.sh:ro \
            --workdir /workspace \
            --name xray-ci-${{ matrix.name }} \
            ${{ matrix.image }} \
            /bin/sh /tmp/xray-ci.sh

  xray-setup-arch-systemd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Arch Linux systemd test image
        run: |
          set -e
          cat > /tmp/Dockerfile.arch-systemd <<'EOF'
          FROM archlinux:latest
          RUN pacman -Syu --noconfirm --needed \
                systemd systemd-sysvcompat \
                curl unzip jq ca-certificates openssl perl python \
              && yes | pacman -Scc
          STOPSIGNAL SIGRTMIN+3
          CMD ["/sbin/init"]
          EOF
          docker build -t arch-systemd-test -f /tmp/Dockerfile.arch-systemd /tmp

      - name: Boot Arch Linux systemd container
        run: |
          set -e
          docker run --privileged --cgroupns=host -d \
            --name arch-sysd \
            --tmpfs /run --tmpfs /tmp \
            -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
            -v "$PWD":/workspace \
            --workdir /workspace \
            arch-systemd-test

          # Wait for systemd (running inside the container) to be ready.
          for i in $(seq 1 40); do
            state="$(docker exec arch-sysd systemctl is-system-running 2>/dev/null || true)"
            if [ "$state" = "running" ] || [ "$state" = "degraded" ]; then
              break
            fi
            sleep 1
          done
          state="$(docker exec arch-sysd systemctl is-system-running 2>/dev/null || true)"
          echo "systemd state: $state"
          if [ "$state" != "running" ] && [ "$state" != "degraded" ]; then
            docker logs arch-sysd || true
            exit 1
          fi

      - name: Install Xray (binary + geo assets) in Arch container
        run: |
          set -e
          docker exec arch-sysd sh -lc '
            set -e
            mkdir -p /tmp/xray && cd /tmp/xray
            release_json=$(curl -fsSL https://api.github.com/repos/XTLS/Xray-core/releases/latest)
            XRAY_ZIP=$(printf "%s" "$release_json" | jq -r ".assets[] | select(.name==\"Xray-linux-64.zip\") | .browser_download_url" | head -n1)
            test -n "$XRAY_ZIP"
            echo "Downloading Xray from $XRAY_ZIP"
            curl -fsSL "$XRAY_ZIP" -o xray.zip
            unzip -q xray.zip
            install -m 0755 xray /usr/local/bin/xray
            install -d /usr/local/share/xray
            install -m 0644 geoip.dat geosite.dat /usr/local/share/xray/
          '

      - name: Run setup script and assert systemd service (Arch)
        run: |
          set -e
          docker exec arch-sysd sh -lc '
            set -e
            export XRAY_LOCATION_ASSET=/usr/local/share/xray
            printf "xray-ci\nexample.com\n14443\n18443\n" | /bin/sh /workspace/xray/setup-xray-vless-ss.sh
            systemctl is-enabled xray-ci.service
            systemctl is-active xray-ci.service
          '

      - name: Cleanup
        if: always()
        run: |
          docker rm -f arch-sysd >/dev/null 2>&1 || true

  xray-setup-alpine-openrc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Alpine OpenRC init test image
        run: |
          set -e
          cat > /tmp/Dockerfile.alpine-openrc <<'EOF'
          FROM alpine:3.20
          RUN apk add --no-cache \
                openrc mdevd-openrc \
                curl unzip jq ca-certificates openssl tzdata gcompat \
            && sed -i '/getty/d' /etc/inittab
          CMD ["/sbin/init"]
          EOF
          docker build -t alpine-openrc-test -f /tmp/Dockerfile.alpine-openrc /tmp

      - name: Boot Alpine OpenRC container
        run: |
          set -e
          docker run --privileged -d \
            --name alpine-openrc \
            --tmpfs /run --tmpfs /tmp \
            -v "$PWD":/workspace \
            --workdir /workspace \
            alpine-openrc-test

          # Wait for OpenRC to reach the default runlevel.
          for i in $(seq 1 40); do
            level="$(docker exec alpine-openrc sh -lc 'cat /run/openrc/softlevel 2>/dev/null || true' | tr -d '\r' || true)"
            echo "softlevel: ${level}"
            if [ "${level}" = "default" ]; then
              break
            fi
            sleep 1
          done
          level="$(docker exec alpine-openrc sh -lc 'cat /run/openrc/softlevel 2>/dev/null || true' | tr -d '\r' || true)"
          if [ "${level}" != "default" ]; then
            docker logs alpine-openrc || true
            exit 1
          fi

      - name: Run setup script and assert OpenRC service (Alpine)
        run: |
          set -e
          docker exec alpine-openrc sh -lc '
            set -e
            export XRAY_LOCATION_ASSET=/usr/local/share/xray
            printf "xray-ci\nexample.com\n14443\n18443\n" | /bin/sh /workspace/xray/setup-xray-vless-ss.sh
            command -v xray
            test -x /etc/init.d/xray-ci
            rc-service xray-ci status | grep -q "started"
          '

      - name: Cleanup
        if: always()
        run: |
          docker rm -f alpine-openrc >/dev/null 2>&1 || true
